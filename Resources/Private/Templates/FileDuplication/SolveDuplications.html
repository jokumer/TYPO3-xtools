<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers"
	xmlns:fl="http://typo3.org/ns/TYPO3/CMS/Filelist/ViewHelpers">
<f:layout name="Default"/>

<f:section name="content">
	<f:flashMessages/>
	<f:link.action
			controller="FileDuplication"
			action="index"
			arguments="{selection:{storage:data.selection.storage.uid, directory:data.selection.path}}"
			class="btn btn-info"
			id="tx_xtools_btn_back_index">
		Back to ../{data.selection.path}
	</f:link.action>
	<h2>
		<f:translate key="controller.fileDuplication.action.index"/>
	</h2>
	<h3>Solved duplications</h3>
	<f:if condition="{preferredFile}">
		<f:then>
			<h4>Preferred file:</h4>
			<p>
				The preferred file replaced duplicated files and changed file references which belongs.
			</p>
			<table class="t3-table t3-datatable">
				<theader>
					<tr>
						<th>Uid</th>
						<th>Preview</th>
						<th>Filename</th>
						<th>Ref</th>
						<th>Meta</th>
						<th>Date (created, modify)</th>
						<th>Path</th>
					</tr>
				</theader>
				<tbody>
					<tr class="odd" role="row">
						<td>
							<fl:link.clickMenuOnIcon table="{preferredFile.combinedIdentifier}">
								{preferredFile.uid}
							</fl:link.clickMenuOnIcon>
						</td>
						<td>
							<f:if condition="{preferredFile.publicUrl}">
								<f:then>
									<a href="{preferredFile.publicUrl}"
									   target="_blank"
									   title="{preferredFile.publicUrl}">
										<f:if condition="{preferredFile.type} == 2">
											<f:image image="{preferredFile}"
													 alt="{preferredFile.name}"
													 treatIdAsReference="0"
													 maxWidth="64"
													 maxHeight="64"
													 style="max-height:64px; max-width:64px;"/>
										</f:if>
									</a>
								</f:then>
								<f:else>
									<span title="{preferredFile.publicUrl}">
										NOT FOUND
									</span>
								</f:else>
							</f:if>
						</td>
						<td>
							<f:if condition="{preferredFile.publicUrl}">
								<f:then>
									<a href="{preferredFile.publicUrl}"
									   target="_blank"
									   title="{preferredFile.publicUrl}">
									{preferredFile.name}
									</a>
								</f:then>
								<f:else>
									<span title="{preferredFile.publicUrl}">
										{preferredFile.name} NOT FOUND
									</span>
								</f:else>
							</f:if>
						</td>
						<td>
							<f:if condition="{f:count(subject:'{preferredFile.references}')}">
								<f:then>
									<f:count subject="{preferredFile.references}"/>
								</f:then>
								<f:else>
									<span title="unknown">?</span>
								</f:else>
							</f:if>
						</td>
						<td>
							<b>Title</b>:&nbsp;{preferredFile.properties.title}<br/>
							<b>Description</b>:&nbsp;{preferredFile.properties.description}<br/>
							<b>Keywords</b>:&nbsp;{preferredFile.properties.keywords}<br/>
							<b>Caption</b>:&nbsp;{preferredFile.properties.caption}<br/>
						</td>
						<td>
							<f:format.date format="Y.m.d. H:i">
								{preferredFile.properties.creation_date}
							</f:format.date> <em>File</em><br/>
							<f:format.date format="Y.m.d. H:i">
								{preferredFile.properties.modification_date}
							</f:format.date> <em>File</em><br/>
							<f:format.date format="Y.m.d. H:i">
								{preferredFile.properties.crdate}
							</f:format.date> <em>DB</em><br/>
							<f:format.date format="Y.m.d. H:i">
								{preferredFile.properties.tstamp}
							</f:format.date> <em>DB</em><br/>
						</td>
						<td>
							<f:if condition="{preferredFile.publicUrl}">
								<f:then>
									{preferredFile.publicUrl}
								</f:then>
								<f:else>
									NOT FOUND
								</f:else>
							</f:if>
						</td>
					</tr>
				</tbody>
			</table>
			<f:if condition="{replacedFiles}">
				<f:then>
					<h4>Replaced files:</h4>
					<p>
						Files has been moved to {replacedFilesTargetPath}, where a log file belongs.
					</p>
					<table class="t3-table t3-datatable">
						<theader>
							<tr>
								<th>Uid</th>
								<th>File</th>
								<th>References</th>
							</tr>
						</theader>
						<tbody>
							<f:for each="{replacedFiles}" as="replacedFile" key="uid" iteration="i">
								<tr class="{f:if(condition: i.isEven, then: 'even', else: 'odd')}" role="row">
									<td>
										{uid}
									</td>
									<td>
										{replacedFile.identifier}
									</td>
									<td>
										<f:if condition="{replacedFile.sysFileReferences}">
											<f:then>
												<f:for each="{replacedFile.sysFileReferences}" as="reference" key="referenceUid" iteration="iteration">
													{f:if(condition:'{iteration.isLast}', then:'{referenceUid}', else:'{referenceUid},')}
												</f:for>
											</f:then>
											<f:else>
												
											</f:else>
										</f:if>
									</td>
								</tr>
							</f:for>
						</tbody>
					</table>
				</f:then>
				<f:else>
					<h4>NO REPLACED FILES</h4>
				</f:else>
			</f:if>
		</f:then>
		<f:else>
			<h4>NO PREFERRED FILE</h4>
		</f:else>
	</f:if>
</f:section>
